/*!
 * The 2022 r/place Catalog
 * Copyright (c) 2017 Roland Rytz <roland@draemm.li>
 * Copyright (c) 2022 Place Atlas contributors
 * Copyright (c) 2022 Hans5958
 * Licensed under AGPL-3.0 (https://hans5958.github.io/place-catalog/license.txt)
 */
const innerContainer=document.getElementById("innerContainer"),container=document.getElementById("container"),canvas=document.getElementById("highlightCanvas"),canvasImage=document.getElementById("image"),context=canvas.getContext("2d");canvas.width=canvasSize.x,canvas.height=canvasSize.y,canvasImage.width=canvasSize.x,canvasImage.height=canvasSize.y;let zoom=1;window.devicePixelRatio&&(zoom=1/window.devicePixelRatio);const maxZoom=128,minZoom=.1;let zoomOrigin=[0,0],scaleZoomOrigin=[0,0],dragging=!1,lastPosition=[0,0];const viewportSize=[0,0];function applyView(){scaleZoomOrigin[0]=Math.max(-canvasCenter.x,Math.min(canvasCenter.x,scaleZoomOrigin[0])),scaleZoomOrigin[1]=Math.max(-canvasCenter.y,Math.min(canvasCenter.y,scaleZoomOrigin[1])),zoomOrigin=[scaleZoomOrigin[0]*zoom,scaleZoomOrigin[1]*zoom],innerContainer.style.height=~~(zoom*canvasSize.x)+"px",innerContainer.style.width=~~(zoom*canvasSize.y)+"px",innerContainer.style.left=~~(container.clientWidth/2-innerContainer.clientWidth/2+zoomOrigin[0]+container.offsetLeft)+"px",innerContainer.style.top=~~(container.clientHeight/2-innerContainer.clientHeight/2+zoomOrigin[1]+container.offsetTop)+"px"}async function init(){const o=window.location.hash.substring(1),[n]=o.split("/");if(n){const[,o,e]=parsePeriod(n);await updateTime(o,e)}else await updateTime(currentPeriod,currentVariation);zoomOrigin=[0,0],applyView();let e=0,t=0,i=[0,0];function c(o,n){lastPosition=[o,n],dragging=!0}function a(o,n){if(dragging){container.style.cursor="move";const e=o-lastPosition[0],t=n-lastPosition[1];lastPosition=[o,n],zoomOrigin[0]+=e,zoomOrigin[1]+=t,scaleZoomOrigin[0]+=e/zoom,scaleZoomOrigin[1]+=t/zoom,previousZoomOrigin=[zoomOrigin[0],zoomOrigin[1]],previousScaleZoomOrigin=[scaleZoomOrigin[0],scaleZoomOrigin[1]],applyView()}}function s(o,n,e){const c=o-lastPosition[0],a=n-lastPosition[1],s=o-container.clientWidth/2-c,l=n-container.clientHeight/2-a;scaleZoomOrigin[0]=i[0]+c/e+s/e-s/t,scaleZoomOrigin[1]=i[1]+a/e+l/e-l/t,zoomOrigin[0]=scaleZoomOrigin[0]*e,zoomOrigin[1]=scaleZoomOrigin[1]*e,applyView()}function l(o,n){dragging&&(dragging=!1)}document.body.dataset.mode="explore",initGlobal(),initViewGlobal(),initExplore(),document.getElementById("loading").classList.add("d-none"),document.getElementById("zoomInButton").addEventListener("click",(function(){const o=container.clientWidth/2,n=container.clientHeight/2;i=[scaleZoomOrigin[0],scaleZoomOrigin[1]],t=zoom,lastPosition=[o,n],zoom*=2,zoom=Math.max(.1,Math.min(128,zoom)),s(o,n,zoom)})),document.getElementById("zoomOutButton").addEventListener("click",(function(){const o=container.clientWidth/2,n=container.clientHeight/2;i=[scaleZoomOrigin[0],scaleZoomOrigin[1]],t=zoom,lastPosition=[o,n],zoom/=2,zoom=Math.max(.1,Math.min(128,zoom)),s(o,n,zoom)})),document.getElementById("zoomResetButton").addEventListener("click",(function(){zoom=1,zoomOrigin=[0,0],scaleZoomOrigin=[0,0],applyView()})),container.addEventListener("dblclick",(function(o){const n=o.clientX-container.offsetLeft,e=o.clientY-container.offsetTop;i=[scaleZoomOrigin[0],scaleZoomOrigin[1]],t=zoom,lastPosition=[n,e],o.ctrlKey?zoom/=2:zoom*=2,zoom=Math.max(.1,Math.min(128,zoom)),s(n,e,zoom),o.preventDefault()})),container.addEventListener("wheel",(function(o){const n=o.clientX-container.offsetLeft,e=o.clientY-container.offsetTop;i=[scaleZoomOrigin[0],scaleZoomOrigin[1]],t=zoom,lastPosition=[n,e],0===o.deltaMode?zoom-=o.deltaY*(.001*zoom):o.deltaY>0?zoom/=2:o.deltaY<0&&(zoom*=2),zoom=Math.max(.1,Math.min(128,zoom)),s(n,e,zoom)}),{passive:!0}),container.addEventListener("mousedown",(function(o){c(o.clientX,o.clientY),o.preventDefault()})),container.addEventListener("touchstart",(function(o){2===o.touches.length&&o.preventDefault(),function(o){1===o.touches.length?c(o.touches[0].clientX,o.touches[0].clientY):2===o.touches.length&&(e=Math.sqrt(Math.pow(o.touches[0].clientX-o.touches[1].clientX,2)+Math.pow(o.touches[0].clientY-o.touches[1].clientY,2)),t=zoom,i=[scaleZoomOrigin[0],scaleZoomOrigin[1]],c((o.touches[0].clientX+o.touches[1].clientX)/2,(o.touches[0].clientY+o.touches[1].clientY)/2))}(o)}),{passive:!0}),window.addEventListener("mousemove",(function(o){a(o.clientX,o.clientY),dragging&&o.preventDefault()})),window.addEventListener("touchmove",(function(o){(2===o.touches.length||o.scale>1)&&o.preventDefault(),function(o){if(1===o.touches.length)a(o.touches[0].clientX,o.touches[0].clientY);else if(2===o.touches.length){const n=Math.sqrt(Math.pow(o.touches[0].clientX-o.touches[1].clientX,2)+Math.pow(o.touches[0].clientY-o.touches[1].clientY,2));zoom=t*n/e;s((o.touches[0].clientX+o.touches[1].clientX)/2-container.offsetLeft,(o.touches[0].clientY+o.touches[1].clientY)/2-container.offsetTop,zoom)}}(o)}),{passive:!1}),window.addEventListener("mouseup",(function(o){container.style.cursor="default",dragging&&o.preventDefault(),l(o.clientX,o.clientY)})),window.addEventListener("touchend",(function(o){0===o.touches.length?l():1===o.touches.length&&(t=zoom,lastPosition=[o.touches[0].clientX,o.touches[0].clientY])})),window.addEventListener("resize",(function(){applyView()})),document.body.dataset.initDone=""}document.location.host!==prodDomain&&(document.body.dataset.dev=""),init();